name: Build Places Database

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build database
        run: |
          cargo build --release --bin build-database
          ./target/release/build-database places.bin
      
      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          TAG_NAME="v$(date -u +%Y%m%d-%H%M%S)"
          
          gh release create "$TAG_NAME" \
            places.bin \
            --title "Places Database Update - $TIMESTAMP" \
            --notes "Automated reverse geocoding database update from GeoNames.org.
          
          **File:**
          - \`places.bin\` - Reverse geocoding database (lat/lon to city/region/timezone)
          
          **Download:**
          \`\`\`bash
          curl -L -O https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/places.bin
          \`\`\`
          
          **Size:** $(du -h places.bin | cut -f1)
          
          **Data Source:** [GeoNames.org](https://www.geonames.org/) (CC BY 4.0)"
      
      - name: Cleanup old releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASES=$(gh release list --limit 100 --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName')
          COUNT=0
          for TAG in $RELEASES; do
            COUNT=$((COUNT + 1))
            if [ $COUNT -gt 3 ]; then
              echo "Deleting old release: $TAG"
              gh release delete "$TAG" --yes 2>/dev/null || true
              git push --delete origin "$TAG" 2>/dev/null || true
            fi
          done
